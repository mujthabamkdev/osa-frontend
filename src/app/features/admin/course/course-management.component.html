<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Course Management</h2>
    <button
      class="btn btn-primary"
      (click)="openCreateCourseModal()"
    >
      <i class="bi bi-plus-circle me-1"></i>
      Create Course
    </button>
  </div>

  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Courses</span>
        </div>
        <div class="card-body">
          @if (coursesLoading()) {
            <div class="text-center py-4">
              <div class="spinner-border text-primary"></div>
            </div>
          } @else {
            @if (!courses().length) {
              <p class="text-muted mb-0">No courses found. Create a course to get started.</p>
            } @else {
              <div class="list-group">
                @for (course of courses(); track course.id) {
                  <div
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    role="button"
                    tabindex="0"
                    [class.active]="selectedCourse()?.id === course.id"
                    (click)="selectCourse(course)"
                  >
                    <div>
                      <div class="fw-semibold">{{ course.title }}</div>
                      <small class="text-muted">{{ course.created_at | date: 'mediumDate' }}</small>
                    </div>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger"
                      (click)="$event.stopPropagation(); deleteCourse(course)"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                }
              </div>
            }
          }
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      @if (!selectedCourse()) {
        <div class="card h-100">
          <div class="card-body d-flex align-items-center justify-content-center text-muted">
            Select a course to manage its subjects, lessons, and content.
          </div>
        </div>
      } @else {
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0">Subjects</h5>
              <small class="text-muted">{{ selectedCourse()?.title }}</small>
            </div>
            <button
              class="btn btn-sm btn-outline-primary"
              (click)="openSubjectModal()"
            >
              <i class="bi bi-plus-circle me-1"></i>
              Add Subject
            </button>
          </div>
          <div class="card-body">
            @if (subjectsLoading()) {
              <div class="text-center py-4">
                <div class="spinner-border text-primary"></div>
              </div>
            } @else if (!subjects().length) {
              <p class="text-muted mb-0">No subjects found. Add your first subject.</p>
            } @else {
              <div class="list-group">
                @for (subject of subjects(); track subject.id) {
                  <div
                    class="list-group-item list-group-item-action subject-card"
                    role="button"
                    tabindex="0"
                    (click)="selectSubject(subject)"
                    [class.active]="selectedSubject()?.id === subject.id"
                  >
                    <div class="d-flex justify-content-between align-items-start gap-3">
                      <div class="subject-meta">
                        <div class="fw-semibold mb-1">{{ subject.name }}</div>
                        <small class="text-muted">Order {{ subject.order_in_course }}</small>
                        <small class="text-muted">Instructor: {{ teacherName(subject.instructor_id) }}</small>
                      </div>
                      <div class="btn-group btn-group-sm">
                        <button
                          class="btn btn-outline-secondary"
                          (click)="$event.stopPropagation(); openSubjectModal(subject)"
                        >
                          Edit
                        </button>
                        <button
                          class="btn btn-outline-danger"
                          (click)="$event.stopPropagation(); deleteSubject(subject)"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                    @if (subject.description) {
                      <p class="mb-0 mt-2 small">{{ subject.description }}</p>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0">Lessons</h5>
              <small class="text-muted">
                @if (selectedSubject()) {
                  {{ selectedSubject()?.name }}
                } @else {
                  Select a subject to view lessons
                }
              </small>
            </div>
            <button
              class="btn btn-sm btn-outline-primary"
              [disabled]="!selectedSubject()"
              (click)="openLessonModal()"
            >
              <i class="bi bi-plus-circle me-1"></i>
              Add Lesson
            </button>
          </div>
          <div class="card-body">
            @if (!selectedSubject()) {
              <p class="text-muted mb-0">Select a subject to manage its lessons.</p>
            } @else if (lessonsLoading()) {
              <div class="text-center py-4">
                <div class="spinner-border text-primary"></div>
              </div>
            } @else if (!lessons().length) {
              <p class="text-muted mb-0">No lessons found for this subject.</p>
            } @else {
              <div class="list-group">
                @for (lesson of lessons(); track lesson.id) {
                  <div
                    class="list-group-item lesson-card"
                    [class.active]="selectedLesson()?.id === lesson.id"
                  >
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <div class="fw-semibold">{{ lesson.title }}</div>
                        <small class="text-muted d-block">Order {{ lesson.order_in_subject }}</small>
                        @if (lesson.scheduled_date) {
                          <small class="text-muted">Scheduled {{ lesson.scheduled_date | date: 'mediumDate' }}</small>
                        }
                      </div>
                      <div class="btn-group btn-group-sm">
                        <button
                          class="btn btn-outline-primary"
                          (click)="selectLesson(lesson)"
                        >
                          Manage Content
                        </button>
                        <button
                          class="btn btn-outline-secondary"
                          (click)="openLessonModal(lesson)"
                        >
                          Edit
                        </button>
                        <button
                          class="btn btn-outline-danger"
                          (click)="deleteLesson(lesson)"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                    @if (lesson.description) {
                      <p class="mb-0 mt-2 small">{{ lesson.description }}</p>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0">Lesson Content</h5>
              <small class="text-muted">
                @if (selectedLesson()) {
                  {{ selectedLesson()?.title }}
                } @else {
                  Select a lesson to view content
                }
              </small>
            </div>
            <button
              class="btn btn-sm btn-outline-primary"
              [disabled]="!selectedLesson()"
              (click)="openContentModal()"
            >
              <i class="bi bi-plus-circle me-1"></i>
              Add Content
            </button>
          </div>
          <div class="card-body">
            @if (!selectedLesson()) {
              <p class="text-muted mb-0">Select a lesson to manage its content.</p>
            } @else if (contentsLoading()) {
              <div class="text-center py-4">
                <div class="spinner-border text-primary"></div>
              </div>
            } @else if (!contents().length) {
              <p class="text-muted mb-0">No content added for this lesson yet.</p>
            } @else {
              <div class="list-group">
                @for (content of contents(); track content.id) {
                  <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <div class="fw-semibold">{{ content.title }}</div>
                        <small class="text-muted d-block">Type: {{ content.content_type | titlecase }}</small>
                        <small class="text-muted">Order {{ content.order_in_lesson }}</small>
                      </div>
                      <div class="btn-group btn-group-sm">
                        <button
                          class="btn btn-outline-secondary"
                          (click)="openContentModal(content)"
                        >
                          Edit
                        </button>
                        <button
                          class="btn btn-outline-danger"
                          (click)="deleteContent(content)"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                    @if (content.content_text) {
                      <p class="mb-0 mt-2 small">{{ content.content_text }}</p>
                    }
                    @if (content.content_url) {
                      <div class="mt-2">
                        <a
                          [href]="content.content_url"
                          target="_blank"
                          rel="noopener"
                        >
                          {{ content.content_url }}
                        </a>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Create Course Modal -->
  @if (showCourseModal()) {
    <div class="modal show d-block" style="background: rgba(0, 0, 0, 0.5)">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create Course</h5>
            <button
              type="button"
              class="btn-close"
              aria-label="Close create course dialog"
              (click)="showCourseModal.set(false)"
            >
              <span class="visually-hidden">Close</span>
            </button>
          </div>
          <div class="modal-body">
            <form #courseForm="ngForm" (ngSubmit)="createCourse()">
              <div class="mb-3">
                <label class="form-label" for="courseTitleInput">Title</label>
                <input
                  type="text"
                  class="form-control"
                  name="title"
                  required
                  id="courseTitleInput"
                  [ngModel]="courseDraft().title"
                  (ngModelChange)="updateCourseTitle($event)"
                />
              </div>
              <div class="mb-3">
                <label class="form-label" for="courseDescriptionInput">Description</label>
                <textarea
                  class="form-control"
                  rows="3"
                  name="description"
                  required
                  id="courseDescriptionInput"
                  [ngModel]="courseDraft().description"
                  (ngModelChange)="updateCourseDescription($event)"
                ></textarea>
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" (click)="showCourseModal.set(false)">
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary" [disabled]="courseForm.invalid || courseSaving()">
                  @if (courseSaving()) {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                  }
                  Create
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Subject Modal -->
  @if (showSubjectModal()) {
    <div class="modal show d-block" style="background: rgba(0, 0, 0, 0.5)">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{{ editingSubjectId() ? 'Edit Subject' : 'Add Subject' }}</h5>
            <button
              type="button"
              class="btn-close"
              aria-label="Close subject dialog"
              (click)="showSubjectModal.set(false)"
            >
              <span class="visually-hidden">Close</span>
            </button>
          </div>
          <div class="modal-body">
            <form #subjectFormRef="ngForm" (ngSubmit)="saveSubject()">
              <div class="mb-3">
                <label class="form-label" for="subjectNameInput">Name</label>
                <input
                  type="text"
                  class="form-control"
                  name="subjectName"
                  required
                  id="subjectNameInput"
                  [ngModel]="subjectForm().name"
                  (ngModelChange)="updateSubjectForm('name', $event)"
                />
              </div>
              <div class="mb-3">
                <label class="form-label" for="subjectDescriptionInput">Description</label>
                <textarea
                  class="form-control"
                  rows="3"
                  name="subjectDescription"
                  id="subjectDescriptionInput"
                  [ngModel]="subjectForm().description"
                  (ngModelChange)="updateSubjectForm('description', $event)"
                ></textarea>
              </div>
              <div class="row g-3">
                <div class="col-6">
                  <label class="form-label" for="subjectOrderInput">Display Order</label>
                  <input
                    type="number"
                    min="1"
                    class="form-control"
                    name="subjectOrder"
                    required
                    id="subjectOrderInput"
                    [ngModel]="subjectForm().order_in_course"
                    (ngModelChange)="updateSubjectForm('order_in_course', $event)"
                  />
                </div>
                <div class="col-6">
                  <div class="d-flex align-items-center justify-content-between">
                    <label class="form-label mb-0" for="subjectInstructorSelect">Instructor</label>
                    @if (teachersLoading()) {
                      <span class="spinner-border spinner-border-sm text-secondary" aria-hidden="true"></span>
                    }
                  </div>
                  <select
                    class="form-select"
                    name="subjectInstructor"
                    [disabled]="teachersLoading()"
                    id="subjectInstructorSelect"
                    [ngModel]="subjectForm().instructor_id ?? ''"
                    (ngModelChange)="updateSubjectForm('instructor_id', $event)"
                  >
                    <option value="">Unassigned</option>
                    @for (teacher of teachers(); track teacher.id) {
                      <option [value]="teacher.id">
                        {{ teacher.full_name || teacher.email }}
                      </option>
                    }
                  </select>
                </div>
              </div>
              <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-secondary" (click)="showSubjectModal.set(false)">
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary" [disabled]="subjectFormRef.invalid || subjectSaving()">
                  @if (subjectSaving()) {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                  }
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Lesson Modal -->
  @if (showLessonModal()) {
    <div class="modal show d-block" style="background: rgba(0, 0, 0, 0.5)">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{{ editingLessonId() ? 'Edit Lesson' : 'Add Lesson' }}</h5>
            <button
              type="button"
              class="btn-close"
              aria-label="Close lesson dialog"
              (click)="showLessonModal.set(false)"
            >
              <span class="visually-hidden">Close</span>
            </button>
          </div>
          <div class="modal-body">
            <form #lessonFormRef="ngForm" (ngSubmit)="saveLesson()">
              <div class="mb-3">
                <label class="form-label" for="lessonTitleInput">Title</label>
                <input
                  type="text"
                  class="form-control"
                  name="lessonTitle"
                  required
                  id="lessonTitleInput"
                  [ngModel]="lessonForm().title"
                  (ngModelChange)="updateLessonForm('title', $event)"
                />
              </div>
              <div class="mb-3">
                <label class="form-label" for="lessonDescriptionInput">Description</label>
                <textarea
                  class="form-control"
                  rows="3"
                  name="lessonDescription"
                  id="lessonDescriptionInput"
                  [ngModel]="lessonForm().description ?? ''"
                  (ngModelChange)="updateLessonForm('description', $event)"
                ></textarea>
              </div>
              <div class="row g-3">
                <div class="col-6">
                  <label class="form-label" for="lessonOrderInput">Display Order</label>
                  <input
                    type="number"
                    min="1"
                    class="form-control"
                    name="lessonOrder"
                    required
                    id="lessonOrderInput"
                    [ngModel]="lessonForm().order_in_subject"
                    (ngModelChange)="updateLessonForm('order_in_subject', $event)"
                  />
                </div>
                <div class="col-6">
                  <label class="form-label" for="lessonDateInput">Scheduled Date</label>
                  <input
                    type="date"
                    class="form-control"
                    name="lessonDate"
                    id="lessonDateInput"
                    [ngModel]="lessonForm().scheduled_date ?? ''"
                    (ngModelChange)="updateLessonForm('scheduled_date', $event)"
                  />
                </div>
              </div>
              <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-secondary" (click)="showLessonModal.set(false)">
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary" [disabled]="lessonFormRef.invalid || lessonSaving()">
                  @if (lessonSaving()) {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                  }
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Content Modal -->
  @if (showContentModal()) {
    <div class="modal show d-block" style="background: rgba(0, 0, 0, 0.5)">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{{ editingContentId() ? 'Edit Content' : 'Add Content' }}</h5>
            <button
              type="button"
              class="btn-close"
              aria-label="Close content dialog"
              (click)="showContentModal.set(false)"
            >
              <span class="visually-hidden">Close</span>
            </button>
          </div>
          <div class="modal-body">
            <form #contentFormRef="ngForm" (ngSubmit)="saveContent()">
              <div class="mb-3">
                <label class="form-label" for="contentTitleInput">Title</label>
                <input
                  type="text"
                  class="form-control"
                  name="contentTitle"
                  required
                  id="contentTitleInput"
                  [ngModel]="contentForm().title"
                  (ngModelChange)="updateContentForm('title', $event)"
                />
              </div>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="contentTypeSelect">Type</label>
                  <select
                    class="form-select"
                    name="contentType"
                    id="contentTypeSelect"
                    required
                    [ngModel]="contentForm().content_type"
                    (ngModelChange)="updateContentForm('content_type', $event)"
                  >
                    <option value="text">Text</option>
                    <option value="video">Video</option>
                    <option value="resource">Resource</option>
                    <option value="link">Link</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="contentOrderInput">Display Order</label>
                  <input
                    type="number"
                    min="1"
                    class="form-control"
                    name="contentOrder"
                    required
                    id="contentOrderInput"
                    [ngModel]="contentForm().order_in_lesson"
                    (ngModelChange)="updateContentForm('order_in_lesson', $event)"
                  />
                </div>
              </div>
              <div class="mb-3 mt-3">
                <label class="form-label" for="contentUrlInput">Content URL</label>
                <input
                  type="url"
                  class="form-control"
                  name="contentUrl"
                  id="contentUrlInput"
                  [ngModel]="contentForm().content_url ?? ''"
                  (ngModelChange)="updateContentForm('content_url', $event)"
                />
              </div>
              <div class="mb-3">
                <label class="form-label" for="contentTextInput">Content Text</label>
                <textarea
                  class="form-control"
                  rows="4"
                  name="contentText"
                  id="contentTextInput"
                  [ngModel]="contentForm().content_text ?? ''"
                  (ngModelChange)="updateContentForm('content_text', $event)"
                ></textarea>
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" (click)="showContentModal.set(false)">
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary" [disabled]="contentFormRef.invalid || contentSaving()">
                  @if (contentSaving()) {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                  }
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  }
</div>
