<div class="container py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
    <h2 class="mb-0">Admin Access Control</h2>
    <div class="d-flex flex-wrap align-items-center gap-2">
      <div class="btn-group" role="group" aria-label="Admin view selector">
        <button
          type="button"
          class="btn"
          [class.btn-primary]="viewMode() === 'pending'"
          [class.btn-outline-primary]="viewMode() !== 'pending'"
          (click)="switchView('pending')"
        >
          Pending Approvals
        </button>
        <button
          type="button"
          class="btn"
          [class.btn-primary]="viewMode() === 'students'"
          [class.btn-outline-primary]="viewMode() !== 'students'"
          (click)="switchView('students')"
        >
          Students
        </button>
        <button
          type="button"
          class="btn"
          [class.btn-primary]="viewMode() === 'parents'"
          [class.btn-outline-primary]="viewMode() !== 'parents'"
          (click)="switchView('parents')"
        >
          Parents
        </button>
      </div>
      @if (viewMode() === 'students') {
        <button type="button" class="btn btn-primary" (click)="openStudentModal()">
          <i class="bi bi-plus-circle me-1"></i>
          Add Student
        </button>
      }
    </div>
  </div>

  @switch (viewMode()) {
    @case ('pending') {
      <div class="card">
        <div class="card-body">
          @if (loadingPending()) {
            <div class="text-center py-5">
              <div class="spinner-border text-primary"></div>
            </div>
          } @else if (!pendingUsers().length) {
            <p class="text-muted mb-0">No accounts are waiting for approval.</p>
          } @else {
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Requested</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @for (user of pendingUsers(); track user.id) {
                    <tr>
                      <td>{{ user.email }}</td>
                      <td>{{ user.full_name || '—' }}</td>
                      <td><span class="badge bg-warning text-dark">{{ user.role | titlecase }}</span></td>
                      <td>{{ user.created_at | date: 'short' }}</td>
                      <td class="text-end">
                        <div class="btn-group btn-group-sm">
                          <button class="btn btn-outline-primary" type="button" (click)="openApprovalModal(user)">
                            Approve
                          </button>
                          <button class="btn btn-outline-danger" type="button" (click)="rejectPendingUser(user)">
                            Remove
                          </button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>
    }

    @case ('students') {
      <div class="card">
        <div class="card-body">
          @if (loadingStudents()) {
            <div class="text-center py-5">
              <div class="spinner-border text-primary"></div>
            </div>
          } @else if (!students().length) {
            <p class="text-muted mb-0">No active students yet. Add a student to get started.</p>
          } @else {
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Courses & Classes</th>
                    <th>Joined</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @for (student of students(); track student.id) {
                    <tr>
                      <td>{{ student.email }}</td>
                      <td>{{ student.full_name || '—' }}</td>
                      <td>
                        @if (student.enrollments.length) {
                          <ul class="mb-0 ps-3">
                            @for (enrollment of student.enrollments; track enrollment.id) {
                              <li>
                                <strong>{{ courseTitle(enrollment.course_id) }}</strong>
                                <span class="text-muted ms-1">
                                  @if (enrollment.class_id) {
                                    ({{ enrollment.class_name || 'Class ' + enrollment.class_id }})
                                  } @else {
                                    (No class assigned)
                                  }
                                </span>
                              </li>
                            }
                          </ul>
                        } @else {
                          <span class="text-muted">No course assignments</span>
                        }
                      </td>
                      <td>{{ student.created_at | date: 'short' }}</td>
                      <td class="text-end">
                        <div class="btn-group btn-group-sm">
                          <button class="btn btn-outline-primary" type="button" (click)="openEnrollmentModal(student)">
                            Manage Courses
                          </button>
                          <button class="btn btn-outline-danger" type="button" (click)="deleteStudent(student)">
                            Delete
                          </button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>
    }

    @case ('parents') {
      <div class="card">
        <div class="card-body">
          @if (loadingParents()) {
            <div class="text-center py-5">
              <div class="spinner-border text-primary"></div>
            </div>
          } @else if (!parents().length) {
            <p class="text-muted mb-0">No active parent accounts.</p>
          } @else {
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Linked Students</th>
                    <th>Approved</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @for (parent of parents(); track parent.id) {
                    <tr>
                      <td>{{ parent.email }}</td>
                      <td>{{ parent.full_name || '—' }}</td>
                      <td>
                        @if (parent.children.length) {
                          <ul class="mb-0 ps-3">
                            @for (child of parent.children; track child.id) {
                              <li>{{ child.full_name || child.email }}</li>
                            }
                          </ul>
                        } @else {
                          <span class="text-muted">No linked students</span>
                        }
                      </td>
                      <td>{{ parent.created_at | date: 'short' }}</td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" type="button" (click)="openParentModal(parent)">
                          Manage Access
                        </button>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>
    }
  }

  @if (approvalModalOpen() && selectedPendingUser()) {
    <div class="modal show d-block" style="background: rgba(0, 0, 0, 0.5)">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Approve {{ selectedPendingUser()?.role | titlecase }} Account</h5>
            <button type="button" class="btn-close" (click)="closeApprovalModal()" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="mb-3 text-muted">
              Review and assign access for <strong>{{ selectedPendingUser()?.email }}</strong>.
            </p>

            @if (selectedPendingUser()?.role === 'student') {
              <div class="mb-3">
                <span class="form-label d-block">Course Assignments</span>
                @if (!approvalAssignments().length) {
                  <p class="text-muted small mb-2">Add at least one course or activate without course access.</p>
                }
                <div class="vstack gap-3">
                  @for (assignment of approvalAssignments(); track $index) {
                    <div class="border rounded p-3">
                      <div class="row g-3 align-items-end">
                        <div class="col-md-6">
                          <label class="form-label" [attr.for]="'approval-course-' + $index">Course</label>
                          <select
                            class="form-select"
                            [attr.id]="'approval-course-' + $index"
                            [ngModel]="assignment.courseId"
                            (ngModelChange)="updateApprovalCourse($index, $event)">
                            <option [ngValue]="null">Select course</option>
                            @for (course of courses(); track course.id) {
                              <option [ngValue]="course.id">{{ course.title }}</option>
                            }
                          </select>
                        </div>
                        <div class="col-md-5">
                          <label class="form-label" [attr.for]="'approval-class-' + $index">Class (optional)</label>
                          @if (isClassLoading(assignment.courseId)) {
                            <div class="form-control"><span class="spinner-border spinner-border-sm"></span></div>
                          } @else {
                            <select
                              class="form-select"
                              [attr.id]="'approval-class-' + $index"
                              [ngModel]="assignment.classId"
                              (ngModelChange)="updateApprovalClass($index, $event)"
                              [disabled]="!assignment.courseId"
                            >
                              <option [ngValue]="null">No class selected</option>
                              @for (classOption of classOptionsForCourse(assignment.courseId); track classOption.id) {
                                <option [ngValue]="classOption.id">
                                  {{ classOption.name }}
                                </option>
                              }
                            </select>
                          }
                        </div>
                        <div class="col-md-1 text-end">
                          <button
                            type="button"
                            class="btn btn-outline-danger btn-sm"
                            (click)="removeApprovalAssignment($index)"
                            [disabled]="approvalAssignments().length === 1"
                          >
                            <i class="bi bi-x-lg"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  }
                </div>
                <button type="button" class="btn btn-link px-0 mt-2" (click)="addApprovalAssignment()">
                  <i class="bi bi-plus-circle me-1"></i>
                  Add course assignment
                </button>
              </div>
            }

            @if (selectedPendingUser()?.role === 'parent') {
              <div class="mb-3">
                <span class="form-label d-block">Link to Students</span>
                @if (!students().length) {
                  <p class="text-muted">No students available to link yet.</p>
                } @else {
                  <div class="row row-cols-1 row-cols-md-2 g-2">
                    @for (option of studentOptions(); track option.id) {
                      <div class="col">
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            [id]="'parent-link-' + option.id"
                            [checked]="approvalChildIds().includes(option.id)"
                            (change)="toggleApprovalChild(option.id)"
                          />
                          <label class="form-check-label" [for]="'parent-link-' + option.id">
                            {{ option.label }}
                          </label>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeApprovalModal()">Cancel</button>
            <button type="button" class="btn btn-primary" (click)="submitApproval()" [disabled]="approving()">
              @if (approving()) {
                <span class="spinner-border spinner-border-sm me-2"></span>
              }
              Approve Account
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (enrollmentModalOpen() && selectedStudent()) {
    <div class="modal show d-block" style="background: rgba(0, 0, 0, 0.5)">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Manage Courses for {{ selectedStudent()?.full_name || selectedStudent()?.email }}</h5>
            <button type="button" class="btn-close" (click)="closeEnrollmentModal()" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="vstack gap-3">
              @for (assignment of enrollmentAssignments(); track $index) {
                <div class="border rounded p-3">
                  <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                      <label class="form-label" [attr.for]="'enrollment-course-' + $index">Course</label>
                      <select
                        class="form-select"
                        [attr.id]="'enrollment-course-' + $index"
                        [ngModel]="assignment.courseId"
                        (ngModelChange)="updateEnrollmentCourse($index, $event)"
                      >
                        <option [ngValue]="null">Select course</option>
                        @for (course of courses(); track course.id) {
                          <option [ngValue]="course.id">{{ course.title }}</option>
                        }
                      </select>
                    </div>
                    <div class="col-md-5">
                      <label class="form-label" [attr.for]="'enrollment-class-' + $index">Class (optional)</label>
                      @if (isClassLoading(assignment.courseId)) {
                        <div class="form-control"><span class="spinner-border spinner-border-sm"></span></div>
                      } @else {
                        <select
                          class="form-select"
                          [disabled]="!assignment.courseId"
                          [attr.id]="'enrollment-class-' + $index"
                          [ngModel]="assignment.classId"
                          (ngModelChange)="updateEnrollmentClass($index, $event)"
                        >
                          <option [ngValue]="null">No class selected</option>
                          @for (classOption of classOptionsForCourse(assignment.courseId); track classOption.id) {
                            <option [ngValue]="classOption.id">
                              {{ classOption.name }}
                            </option>
                          }
                        </select>
                      }
                    </div>
                    <div class="col-md-1 text-end">
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm"
                        (click)="removeEnrollmentAssignment($index)"
                        [disabled]="enrollmentAssignments().length === 1"
                      >
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </div>
                  </div>
                </div>
              }
            </div>
            <button type="button" class="btn btn-link px-0 mt-3" (click)="addEnrollmentAssignment()">
              <i class="bi bi-plus-circle me-1"></i>
              Add course assignment
            </button>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeEnrollmentModal()">Cancel</button>
            <button type="button" class="btn btn-primary" (click)="saveEnrollmentAssignments()" [disabled]="enrollmentSaving()">
              @if (enrollmentSaving()) {
                <span class="spinner-border spinner-border-sm me-2"></span>
              }
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (parentModalOpen() && selectedParent()) {
    <div class="modal show d-block" style="background: rgba(0, 0, 0, 0.5)">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Manage Student Access for {{ selectedParent()?.email }}</h5>
            <button type="button" class="btn-close" (click)="closeParentModal()" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            @if (!students().length) {
              <p class="text-muted mb-0">No students available to assign.</p>
            } @else {
              <div class="row row-cols-1 row-cols-md-2 g-2">
                @for (option of studentOptions(); track option.id) {
                  <div class="col">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        [id]="'parent-select-' + option.id"
                        [checked]="parentChildSelection().includes(option.id)"
                        (change)="toggleParentChild(option.id)"
                      />
                      <label class="form-check-label" [for]="'parent-select-' + option.id">
                        {{ option.label }}
                      </label>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeParentModal()">Cancel</button>
            <button type="button" class="btn btn-primary" (click)="saveParentChildren()" [disabled]="parentSaving()">
              @if (parentSaving()) {
                <span class="spinner-border spinner-border-sm me-2"></span>
              }
              Save Access
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (studentModalOpen()) {
    <div class="modal show d-block" style="background: rgba(0, 0, 0, 0.5)">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Student</h5>
            <button type="button" class="btn-close" (click)="closeStudentModal()" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label class="form-label" for="studentFullNameInput">Full Name</label>
                <input
                  id="studentFullNameInput"
                  type="text"
                  class="form-control"
                  [ngModel]="newStudentForm().full_name"
                  (ngModelChange)="updateNewStudentField('full_name', $event)"
                  name="studentFullName"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label" for="studentEmailInput">Email</label>
                <input
                  id="studentEmailInput"
                  type="email"
                  class="form-control"
                  [ngModel]="newStudentForm().email"
                  (ngModelChange)="updateNewStudentField('email', $event)"
                  name="studentEmail"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label" for="studentPasswordInput">Temporary Password</label>
                <input
                  id="studentPasswordInput"
                  type="password"
                  class="form-control"
                  [ngModel]="newStudentForm().password"
                  (ngModelChange)="updateNewStudentField('password', $event)"
                  name="studentPassword"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeStudentModal()">Cancel</button>
            <button type="button" class="btn btn-primary" (click)="saveStudent()" [disabled]="creatingStudent()">
              @if (creatingStudent()) {
                <span class="spinner-border spinner-border-sm me-2"></span>
              }
              Add Student
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
